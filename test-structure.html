<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表结构测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header">
                <h5>表结构显示测试</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">连接ID</label>
                    <input type="text" class="form-control" id="connectionId" value="test_conn_1">
                </div>
                <div class="mb-3">
                    <label class="form-label">数据库</label>
                    <input type="text" class="form-control" id="database" value="test">
                </div>
                <div class="mb-3">
                    <label class="form-label">表名</label>
                    <input type="text" class="form-control" id="table" value="users">
                </div>
                <button class="btn btn-primary" onclick="testTableStructure()">测试表结构</button>
                <button class="btn btn-secondary" onclick="clearOutput()">清空输出</button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6>调试输出</h6>
            </div>
            <div class="card-body">
                <div id="debugOutput" class="debug-output"></div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6>表结构显示</h6>
            </div>
            <div class="card-body">
                <div id="structureOutput"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        function log(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('debugOutput').textContent = '';
            document.getElementById('structureOutput').innerHTML = '';
        }

        function testTableStructure() {
            clearOutput();

            const connectionId = document.getElementById('connectionId').value;
            const database = document.getElementById('database').value;
            const table = document.getElementById('table').value;

            log(`开始测试表结构查询...`);
            log(`连接ID: ${connectionId}`);
            log(`数据库: ${database}`);
            log(`表名: ${table}`);

            fetch(`/api/structure/${connectionId}/${database}/${table}`)
                .then(response => response.json())
                .then(result => {
                    log(`API响应: ${JSON.stringify(result, null, 2)}`);

                    if (result.success) {
                        log('表结构查询成功');
                        displayTableStructure(result.data);
                    } else {
                        log(`错误: ${result.error}`);
                    }
                })
                .catch(error => {
                    log(`网络错误: ${error.message}`);
                });
        }

        function displayTableStructure(data) {
            const container = document.getElementById('structureOutput');
            let html = '';

            log('开始显示表结构...');

            if (!data.columns || data.columns.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">没有找到表结构信息</div>';
                log('没有找到列信息');
                return;
            }

            log(`找到 ${data.columns.length} 个列`);

            // 显示基本信息
            html += `
                <div class="alert alert-info">
                    <strong>表结构信息</strong> - 共找到 ${data.columns.length} 个列
                </div>
            `;

            // 显示列信息
            html += `
                <h6><i class="fas fa-columns"></i> 列信息</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>列名</th>
                                <th>类型</th>
                                <th>长度</th>
                                <th>可空</th>
                                <th>默认值</th>
                                <th>主键</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.columns.forEach(col => {
                log(`处理列: ${JSON.stringify(col)}`);

                // MySQL DESCRIBE 返回的字段名
                const isPrimary = col.Key === 'PRI';
                const isNullable = col.Null === 'YES';

                html += `
                    <tr>
                        <td><strong>${col.Field || col.column_name || col.name || 'undefined'}</strong></td>
                        <td><code>${col.Type || col.data_type || col.type || 'undefined'}</code></td>
                        <td>${extractLengthFromType(col.Type || col.data_type || col.type) || '-'}</td>
                        <td>
                            <span class="badge ${isNullable ? 'bg-success' : 'bg-danger'}">
                                ${isNullable ? '可空' : '非空'}
                            </span>
                        </td>
                        <td>${col.Default || col.column_default || col.defaultValue || '-'}</td>
                        <td>
                            ${isPrimary ? '<span class="badge bg-primary"><i class="fas fa-key"></i> 主键</span>' : '-'}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            </div>
            `;

            // 显示索引信息
            if (data.indexes && data.indexes.length > 0) {
                log(`找到 ${data.indexes.length} 个索引`);
                html += `
                    <h6><i class="fas fa-search"></i> 索引信息</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>索引名</th>
                                    <th>类型</th>
                                    <th>列</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.indexes.forEach(index => {
                    log(`处理索引: ${JSON.stringify(index)}`);

                    // MySQL SHOW INDEX 返回的字段名
                    const isUnique = index.Non_unique === 0;
                    const indexType = index.Index_type || 'BTREE';

                    html += `
                        <tr>
                            <td><strong>${index.Key_name || index.index_name || index.name || 'undefined'}</strong></td>
                            <td>
                                <span class="badge ${isUnique ? 'bg-warning' : 'bg-info'}">
                                    ${isUnique ? 'UNIQUE' : indexType.toUpperCase()}
                                </span>
                            </td>
                            <td>${index.Column_name || index.column_name || index.columns || '-'}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
                `;
            }

            // 显示外键信息
            if (data.foreignKeys && data.foreignKeys.length > 0) {
                log(`找到 ${data.foreignKeys.length} 个外键`);
                html += `
                    <h6><i class="fas fa-link"></i> 外键信息</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>约束名</th>
                                    <th>列</th>
                                    <th>引用表</th>
                                    <th>引用列</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.foreignKeys.forEach(fk => {
                    log(`处理外键: ${JSON.stringify(fk)}`);

                    html += `
                        <tr>
                            <td><strong>${fk.CONSTRAINT_NAME || fk.name || 'FK'}</strong></td>
                            <td><code>${fk.COLUMN_NAME || fk.column || '-'}</code></td>
                            <td><code>${fk.REFERENCED_TABLE_NAME || fk.referencedTable || '-'}</code></td>
                            <td><code>${fk.REFERENCED_COLUMN_NAME || fk.referencedColumn || '-'}</code></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
                `;
            }

            container.innerHTML = html;
            log('表结构显示完成');
        }

        function extractLengthFromType(typeString) {
            if (!typeString) return null;
            const match = typeString.match(/\((\d+)\)/);
            return match ? match[1] : null;
        }

        // 页面加载完成后的初始化
        $(document).ready(function() {
            log('页面加载完成');
            log('可以开始测试表结构显示功能');
        });
    </script>
</body>
</html>